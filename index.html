<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>My n8n Chatbot</title>
  <style>
    :root { --bg:#0b1020; --panel:#151c34; --text:#e8ecff; --muted:#9aa6d1; --accent:#7aa2ff; }
    * { box-sizing:border-box; }
    body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; background:var(--bg); color:var(--text); }
    .wrap { max-width: 780px; margin: 0 auto; padding: clamp(12px, 3vw, 24px); min-height:100dvh; display:flex; flex-direction:column; gap:16px; }
    header { display:flex; align-items:center; justify-content:space-between; gap:8px; }
    h1 { font-size: 18px; margin:0; font-weight:600; letter-spacing:.2px; }
    .actions { display:flex; gap:8px; }
    button, .btn { background:var(--panel); color:var(--text); border:1px solid #263056; padding:10px 12px; border-radius:12px; cursor:pointer; }
    button:hover { border-color:#33406f; }
    .chat { flex:1; overflow:auto; display:flex; flex-direction:column; gap:10px; padding:4px; }
    .msg { padding:12px 14px; border-radius:14px; line-height:1.4; max-width:85%; white-space:pre-wrap; }
    .user { align-self:flex-end; background:#1d2545; border:1px solid #2d3763; }
    .bot { align-self:flex-start; background:#0f1430; border:1px solid #263056; }
    .muted { color:var(--muted); font-size:12px; }
    form { display:flex; gap:10px; align-items:center; }
    textarea { flex:1; background:#0f1430; color:var(--text); border:1px solid #263056; border-radius:12px; padding:12px; min-height:50px; max-height:200px; resize:vertical; }
    .send { padding:12px 16px; }
    .footer { display:flex; justify-content:space-between; align-items:center; }
    .tiny { font-size:12px; color:var(--muted); }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>ðŸ¤– Moe's BOT</h1>
      <div class="actions">
        <button id="clear">Clear chat</button>
        <button id="export">Export</button>
      </div>
    </header>

    <div id="chat" class="chat"></div>

    <form id="composer">
      <textarea id="input" placeholder="Type a message..." rows="2" enterkeyhint="send"></textarea>
      <input type="file" id="fileInput" style="display:none" />
      <button type="button" id="attach">ðŸ“Ž</button>
      <button class="send" type="submit">Send</button>
    </form>

    <div class="footer">
      <span class="tiny">Powered by Moe</span>
      <span class="tiny" id="status"></span>
    </div>
  </div>

  <script>
    // ==== CONFIG ====
    const WORKER_PROXY_URL = 'https://lessonplans.ftwmido.workers.dev/'; // your Worker URL
    const prefersDark = true;
    const SEND_ONLY_LAST = true;
    const MAX_CONTEXT_TO_SEND = 1;

    if (prefersDark) document.documentElement.classList.add('dark');

    const chatEl = document.getElementById('chat');
    const form = document.getElementById('composer');
    const input = document.getElementById('input');
    const statusEl = document.getElementById('status');
    const clearBtn = document.getElementById('clear');
    const exportBtn = document.getElementById('export');
    const fileInput = document.getElementById('fileInput');
    const attachBtn = document.getElementById('attach');

    const SESSION_KEY = 'n8nchat.session';
    const HISTORY_KEY = 'n8nchat.history';

    let session = localStorage.getItem(SESSION_KEY) || crypto.randomUUID();
    localStorage.setItem(SESSION_KEY, session);

    let history = JSON.parse(localStorage.getItem(HISTORY_KEY) || '[]');
    let attachedFile = null;

    function saveHistory() {
      localStorage.setItem(HISTORY_KEY, JSON.stringify(history));
    }

    function addMsg(role, content) {
      const div = document.createElement('div');
      div.className = `msg ${role === 'user' ? 'user' : 'bot'}`;
      div.textContent = content;
      chatEl.appendChild(div);
      chatEl.scrollTop = chatEl.scrollHeight;
    }

    function renderHistory() {
      chatEl.innerHTML = '';
      for (const m of history) addMsg(m.role, m.content);
    }

    function setStatus(t) { statusEl.textContent = t || ''; }

    renderHistory();

    attachBtn.addEventListener('click', () => fileInput.click());
    fileInput.addEventListener('change', () => {
      if (fileInput.files.length > 0) {
        attachedFile = fileInput.files[0];
        setStatus(`Attached: ${attachedFile.name}`);
      } else {
        attachedFile = null;
        setStatus('');
      }
    });

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      const text = input.value.trim();
      if (!text && !attachedFile) return;
      input.value = '';

      // Add to chat + history (but NOT base64 file content)
      if (text) {
        history.push({ role: 'user', content: text });
        addMsg('user', text);
      }
      if (attachedFile) {
        addMsg('user', `[File: ${attachedFile.name}]`);
      }
      saveHistory();

      const typing = { role: 'assistant', content: 'â€¦' };
      history.push(typing); addMsg('assistant', 'â€¦'); setStatus('Thinkingâ€¦');

      try {
        let fileData = null;
        if (attachedFile) {
          const buf = await attachedFile.arrayBuffer();
          fileData = {
            name: attachedFile.name,
            type: attachedFile.type,
            size: attachedFile.size,
            data: btoa(String.fromCharCode(...new Uint8Array(buf)))
          };
        }

        const msgsToSend = SEND_ONLY_LAST
          ? [{ role: 'user', content: text || `[File: ${attachedFile?.name}]` }]
          : history.filter(m => m.content !== 'â€¦').slice(-MAX_CONTEXT_TO_SEND);

        const payload = {
          session_id: session,
          messages: msgsToSend,
          last_user_message: text || `[File: ${attachedFile?.name}]`,
          file: fileData,   // file goes to n8n but not stored in history
          metadata: { client: 'static-site', ts: Date.now() }
        };

        const res = await fetch(WORKER_PROXY_URL, {
          method: 'POST',
          headers: { 'content-type': 'application/json' },
          body: JSON.stringify(payload)
        });

        history = history.filter(m => m !== typing);

        if (!res.ok) throw new Error(await res.text() || res.statusText);
        const data = await res.json();
        const reply = (data && (data.reply || data.text || data.message)) || '[No reply]';

        history.push({ role: 'assistant', content: reply });
        saveHistory();
        renderHistory();
        setStatus('');
      } catch (err) {
        history = history.filter(m => m !== typing);
        history.push({ role: 'assistant', content: 'Error: ' + err.message });
        saveHistory();
        renderHistory();
        setStatus('');
      } finally {
        attachedFile = null;
        fileInput.value = '';
      }
    });

    // ENTER to send (Shift+Enter for newline)
    input.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        form.requestSubmit();
      }
    });

    clearBtn.addEventListener('click', () => {
      if (!confirm('Clear conversation?')) return;
      history = [];
      saveHistory();
      renderHistory();
    });

    exportBtn.addEventListener('click', () => {
      const blob = new Blob([JSON.stringify({ session, history }, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = `chat-${session}.json`; a.click();
      URL.revokeObjectURL(url);
    });
  </script>
</body>
</html>
